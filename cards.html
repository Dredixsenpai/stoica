<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Stoic Way – Daily Cards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050507;
      --border-subtle: #232323;
      --accent: #f4c15d;
      --accent-soft: #f8dd9b;
      --accent-3: #f06c5f;
      --text: #f5f5f5;
      --muted: #9f9f9f;
      --card-radius: 24px;
      --transition-fast: 0.22s ease-out;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow-x: hidden; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050507;
      color: var(--text);
      min-height: 100vh;
    }

    a { color: inherit; text-decoration: none; }

    /* ───── HEADER ───── */

    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1180px;
      margin: 0 auto;
      padding: 20px 24px;
      transition: padding 0.3s ease, background 0.3s ease;
    }

    header.scrolled {
      padding: 12px 24px;
      background: rgba(5,5,7,0.88);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,0.04);
      left: 0; right: 0;
      max-width: none;
    }

    .logo {
      font-family: "Times New Roman", Georgia, serif;
      font-size: 26px;
      letter-spacing: 0.38em;
      text-transform: uppercase;
    }

    nav { display: flex; gap: 20px; font-size: 13px; text-transform: uppercase; letter-spacing: 0.14em; }
    nav a { color: var(--muted); padding-bottom: 3px; border-bottom: 1px solid transparent; transition: color var(--transition-fast), border-color var(--transition-fast); }
    nav a:hover { color: var(--accent-soft); border-bottom-color: var(--accent-soft); }

    /* ───── HERO ───── */

    .hero {
      position: relative;
      width: 100%;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        linear-gradient(180deg, rgba(0,0,0,0.15) 0%, #050507 78%),
        url("https://images.unsplash.com/photo-1470770841072-f978cf4d019e?auto=format&fit=crop&w=1900&q=80") center/cover no-repeat;
    }

    .hero-inner { max-width: 640px; padding: 140px 24px 100px; text-align: center; }
    .hero-kicker { font-size: 12px; text-transform: uppercase; letter-spacing: 0.22em; color: var(--muted); margin-bottom: 18px; }
    .hero-title { font-size: clamp(32px, 5.5vw, 52px); font-weight: 700; line-height: 1.1; margin-bottom: 18px; }
    .hero-title .em { color: var(--accent-3); }
    .hero-subtitle { font-size: 15px; color: var(--muted); line-height: 1.65; max-width: 480px; margin: 0 auto 36px; }

    .cta-button {
      border: none; border-radius: 999px; padding: 14px 32px;
      font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.18em;
      background: linear-gradient(135deg, var(--accent), var(--accent-3));
      color: #050507; cursor: pointer;
      box-shadow: 0 14px 36px rgba(0,0,0,0.7);
      transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
    }
    .cta-button:hover { transform: translateY(-2px); box-shadow: 0 20px 48px rgba(0,0,0,0.85); filter: brightness(1.06); }
    .cta-hint { margin-top: 12px; font-size: 11px; color: var(--muted); }

    /* ───── FILTER SECTION ───── */

    .filter-section {
      position: relative;
      width: 100%;
      padding: 80px 24px 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: linear-gradient(180deg, #050507 0%, #0a0a0d 50%, #050507 100%);
    }

    .filter-heading {
      font-size: clamp(22px, 3.5vw, 32px);
      font-weight: 600;
      text-align: center;
      margin-bottom: 8px;
    }

    .filter-sub {
      font-size: 14px;
      color: var(--muted);
      text-align: center;
      margin-bottom: 36px;
    }

    .filter-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #555;
      margin-bottom: 14px;
      text-align: center;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      max-width: 720px;
      margin-bottom: 24px;
    }

    .filter-pill {
      padding: 9px 20px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(17,17,17,0.5);
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: all var(--transition-fast);
      user-select: none;
    }

    .filter-pill:hover {
      border-color: #3a3a3a;
      color: var(--text);
      background: rgba(30,30,30,0.6);
      transform: translateY(-1px);
    }

    .filter-pill.active {
      border-color: var(--accent);
      color: var(--accent-soft);
      background: rgba(244,193,93,0.08);
      box-shadow: 0 0 16px rgba(244,193,93,0.08);
    }

    .theme-filters {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height 0.4s cubic-bezier(0.22,1,0.36,1), opacity 0.3s ease, margin 0.3s ease;
      margin-bottom: 0;
    }

    .theme-filters.visible {
      max-height: 120px;
      opacity: 1;
      margin-bottom: 20px;
    }

    .theme-filters .filter-row {
      margin-bottom: 0;
    }

    .theme-pill {
      padding: 6px 14px;
      font-size: 11px;
      letter-spacing: 0.06em;
    }

    .filter-reset {
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      border: none;
      background: none;
      padding: 6px 12px;
      transition: color var(--transition-fast);
      margin-top: 4px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, color var(--transition-fast);
    }

    .filter-reset.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .filter-reset:hover {
      color: var(--accent-soft);
    }

    .filter-result-count {
      font-size: 12px;
      color: #555;
      margin-top: 8px;
      min-height: 18px;
      transition: opacity 0.3s ease;
    }

    /* ───── EXPLORE BUTTON ───── */

    .explore-wrap {
      margin-top: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .explore-divider {
      width: 48px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
      margin-bottom: 8px;
    }

    .explore-button {
      border: none;
      border-radius: 999px;
      padding: 16px 40px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      background: linear-gradient(135deg, var(--accent), var(--accent-3));
      color: #050507;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
    }

    .explore-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 40px rgba(0,0,0,0.7);
      filter: brightness(1.06);
    }

    .explore-button:active {
      transform: translateY(0);
    }

    .explore-context {
      font-size: 12px;
      color: #555;
      max-width: 320px;
      text-align: center;
      line-height: 1.5;
    }

    /* ───── BACK TO FILTER (hamburger) ───── */

    .back-to-filter {
      position: absolute;
      top: 24px;
      left: 24px;
      width: 42px;
      height: 42px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: rgba(17,17,17,0.6);
      color: var(--muted);
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: background var(--transition-fast), border-color var(--transition-fast),
                  color var(--transition-fast), transform var(--transition-fast);
    }

    .back-to-filter:hover {
      background: rgba(30,30,30,0.8);
      border-color: #3a3a3a;
      color: var(--accent-soft);
      transform: scale(1.06);
    }

    .back-to-filter:active {
      transform: scale(0.96);
    }

    .back-to-filter svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      fill: none;
    }

    /* ───── DECK SECTION ───── */

    .deck-section {
      position: relative; width: 100%; min-height: 100vh;
      padding: 80px 24px 120px;
      background: radial-gradient(ellipse at top, #0f0f11 0%, #050507 60%);
      display: flex; flex-direction: column; align-items: center;
    }

    .deck-header { text-align: center; margin-bottom: 48px; }
    .deck-header h2 { font-size: 13px; text-transform: uppercase; letter-spacing: 0.2em; color: var(--muted); margin-bottom: 6px; transition: opacity 0.3s ease; }
    .deck-counter { font-size: 12px; color: #555; font-variant-numeric: tabular-nums; }

    /* ═══════════════════════════════════════════
       CARD DECK — 3-layer structure:
       .deck-card    → stack position (translateY, scale, opacity)
       .card-flipper → 3D flip rotation (rotateY)
       .card-front / .card-back → the two faces
       ═══════════════════════════════════════════ */

    .deck-stage {
      position: relative;
      width: 100%;
      max-width: 620px;
      height: 520px;
      perspective: 1200px;
    }

    .deck-card {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      cursor: default;
      transition: transform 0.32s cubic-bezier(0.22, 1, 0.36, 1),
                  opacity 0.32s cubic-bezier(0.22, 1, 0.36, 1);
      will-change: transform, opacity;
    }

    .deck-card[data-pos="0"] { z-index: 10; transform: translateY(0) scale(1); opacity: 1; }
    .deck-card[data-pos="1"] { z-index: 9; transform: translateY(16px) scale(0.97); opacity: 0.55; pointer-events: none; }
    .deck-card[data-pos="2"] { z-index: 8; transform: translateY(30px) scale(0.94); opacity: 0.3; pointer-events: none; }
    .deck-card[data-pos="hidden"] { z-index: 1; transform: translateY(44px) scale(0.91); opacity: 0; pointer-events: none; }

    .deck-card.swipe-left {
      transition: transform 0.28s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.25s ease;
      transform: translateX(-130%) rotate(-6deg) !important;
      opacity: 1 !important;
      z-index: 11 !important;
    }

    .card-flipper {
      position: relative;
      width: 100%;
      transform-style: preserve-3d;
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .card-flipper.face-down {
      transform: rotateY(180deg);
    }

    .card-face {
      border-radius: var(--card-radius);
      border: 1px solid var(--border-subtle);
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .card-front {
      position: relative;
      background: radial-gradient(ellipse at top left, #1a1a1c 0%, #0e0e10 55%);
      padding: 36px 32px 28px;
    }

    .card-back {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: radial-gradient(ellipse at center, #141416 0%, #0b0b0d 70%);
      transform: rotateY(180deg);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
    }

    .card-back::after {
      content: "";
      position: absolute;
      inset: 18px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.05);
      pointer-events: none;
      background: radial-gradient(circle at 50% 40%, rgba(244,193,93,0.025) 0%, transparent 70%);
    }

    .card-back-logo {
      font-family: "Times New Roman", Georgia, serif;
      font-size: 32px;
      letter-spacing: 0.55em;
      color: rgba(255,255,255,0.1);
      text-transform: uppercase;
      padding-left: 0.55em;
    }

    .card-back-rule {
      width: 60px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(244,193,93,0.15), transparent);
    }

    .card-back-sub {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.25em;
      color: rgba(255,255,255,0.05);
    }

    /* ───── CARD CONTENT ───── */

    .card-theme-pill {
      display: inline-block;
      padding: 5px 14px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.4);
      font-size: 11px; text-transform: uppercase; letter-spacing: 0.16em;
      color: var(--accent-soft);
      margin-bottom: 28px;
    }

    .card-quote {
      font-family: Georgia, "Times New Roman", serif;
      font-size: clamp(19px, 2.6vw, 24px);
      line-height: 1.65; font-weight: 400;
      margin-bottom: 24px; color: #f0f0f0;
    }
    .card-quote::before { content: "\201C"; }
    .card-quote::after  { content: "\201D"; }

    .card-attribution { display: flex; align-items: baseline; gap: 10px; margin-bottom: 8px; }
    .card-author { font-size: 18px; font-weight: 600; color: var(--text); }
    .card-source { font-size: 13px; color: var(--muted); font-style: italic; }

    .card-divider {
      width: 40px; height: 1px;
      background: linear-gradient(90deg, var(--accent), transparent);
      margin: 22px 0;
    }

    /* ───── EXPANDABLE EXPLANATION ───── */

    .card-explain-toggle {
      display: inline-flex; align-items: center; gap: 8px;
      border: none; background: none;
      color: var(--accent-soft); font-size: 13px; letter-spacing: 0.06em;
      cursor: pointer; padding: 6px 0;
      transition: color var(--transition-fast);
    }
    .card-explain-toggle:hover { color: var(--accent); }
    .card-explain-toggle .toggle-icon { display: inline-block; transition: transform 0.3s ease; font-size: 11px; }
    .card-explain-toggle.open .toggle-icon { transform: rotate(180deg); }

    .card-explanation {
      max-height: 0; overflow: hidden; opacity: 0;
      transition: max-height 0.4s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.3s ease;
    }
    .card-explanation.open { max-height: 180px; opacity: 1; overflow-y: auto; }
    .card-explanation.open::-webkit-scrollbar { width: 5px; }
    .card-explanation.open::-webkit-scrollbar-track { background: transparent; }
    .card-explanation.open::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    .card-explanation.open::-webkit-scrollbar-thumb:hover { background: #555; }

    .card-explanation-inner { padding-top: 16px; padding-right: 8px; font-size: 14px; line-height: 1.75; color: #c8c8c8; }
    .card-explanation-inner strong { color: var(--accent); font-weight: 500; }

    /* ───── NAVIGATION ───── */

    .deck-stage-wrapper {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .deck-nav { display: flex; align-items: center; justify-content: center; gap: 20px; margin-top: 40px; }

    .nav-arrow {
      width: 48px; height: 48px; border-radius: 50%;
      border: 1px solid var(--border-subtle);
      background: rgba(17,17,17,0.6);
      color: var(--muted); font-size: 18px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast),
                  color var(--transition-fast), transform var(--transition-fast);
    }
    .nav-arrow:hover { background: rgba(30,30,30,0.8); border-color: #3a3a3a; color: var(--accent-soft); transform: scale(1.06); }
    .nav-arrow:active { transform: scale(0.96); }

    .nav-arrow-side {
      flex-shrink: 0;
      z-index: 12;
    }

    @media (max-width: 700px) {
      .deck-stage-wrapper { gap: 8px; }
      .nav-arrow-side { width: 36px; height: 36px; font-size: 14px; }
    }

    .nav-dots { display: flex; gap: 8px; }
    .nav-dot { width: 8px; height: 8px; border-radius: 50%; background: #2a2a2a; cursor: pointer; transition: background 0.3s ease, transform 0.3s ease; }
    .nav-dot.active { background: var(--accent); transform: scale(1.25); }

    .deck-hint { margin-top: 16px; font-size: 11px; color: #444; }
    .deck-hint kbd { display: inline-block; padding: 2px 7px; border-radius: 4px; border: 1px solid #333; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 10px; color: #666; background: #111; }

    .about-note { margin-top: 48px; text-align: center; font-size: 13px; color: #444; max-width: 520px; }

    /* ───── EMPTY STATE ───── */

    .deck-empty {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      text-align: center;
      gap: 12px;
    }

    .deck-empty.visible {
      display: flex;
    }

    .deck-empty-icon {
      font-size: 40px;
      opacity: 0.3;
    }

    .deck-empty-text {
      font-size: 15px;
      color: var(--muted);
    }

    .deck-empty-hint {
      font-size: 12px;
      color: #555;
    }

    /* ───── RESPONSIVE ───── */

    @media (max-width: 720px) {
      header { padding: 16px; }
      header.scrolled { padding: 10px 16px; }
      .logo { font-size: 20px; letter-spacing: 0.3em; }
      nav { gap: 14px; font-size: 11px; }
      .hero-inner { padding: 120px 20px 80px; }
      .filter-section { padding: 60px 16px 40px; }
      .filter-row { gap: 8px; }
      .filter-pill { padding: 7px 14px; font-size: 12px; }
      .deck-section { padding: 60px 16px 100px; }
      .deck-stage { max-width: 100%; height: 480px; }
      .card-front { padding: 28px 22px 24px; }
      .card-quote { font-size: 18px; }
      .card-author { font-size: 16px; }
      .card-attribution { flex-direction: column; gap: 4px; }
      .nav-arrow { width: 42px; height: 42px; font-size: 16px; }
      .back-to-filter { top: 16px; left: 16px; width: 38px; height: 38px; }
      .explore-button { padding: 14px 32px; font-size: 13px; }
    }

    @media (max-width: 420px) {
      .deck-stage { height: 500px; }
      .card-quote { font-size: 17px; line-height: 1.6; }
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">STOIC&nbsp;WAY</div>
    <nav>
      <a data-scroll="#hero">Home</a>
      <a data-scroll="#filter">Library</a>
      <a href="index.html">Index</a>
      <a href="admin.html">Admin</a>
    </nav>
  </header>

  <section class="hero" id="hero">
    <div class="hero-inner">
      <div class="hero-kicker">A daily practice for your mind</div>
      <h1 class="hero-title">Train how you <span class="em">meet</span> your life.</h1>
      <p class="hero-subtitle">
        One ancient thought each day, explained for right now. Draw a card,
        sit with it, and watch how your reactions start to change.
      </p>
      <button class="cta-button" id="reveal-deck">What are you facing? &nbsp;&darr;</button>
      <div class="cta-hint">Scroll down or press <strong>Space</strong></div>
    </div>
  </section>

  <!-- FILTER SECTION -->
  <section class="filter-section" id="filter">
    <h2 class="filter-heading">What are you facing?</h2>
    <p class="filter-sub">Choose what feels closest. We'll find the right thought.</p>

    <div class="filter-label">I'm feeling&hellip;</div>
    <div class="filter-row" id="mood-filters"></div>

    <div class="theme-filters" id="theme-filters-wrap">
      <div class="filter-label">Narrow by theme</div>
      <div class="filter-row" id="theme-filters"></div>
    </div>

    <button class="filter-reset" id="filter-reset">Show all cards</button>
    <div class="filter-result-count" id="filter-count"></div>

    <div class="explore-wrap">
      <div class="explore-divider"></div>
      <button class="explore-button" id="explore-btn">Explore</button>
      <div class="explore-context" id="explore-context">Loading library&hellip;</div>
    </div>
  </section>

  <section class="deck-section" id="deck">
    <button class="back-to-filter" id="back-to-filter" aria-label="Back to filters" title="Change filters">
      <svg viewBox="0 0 24 24"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="14" y2="12"/><line x1="4" y1="18" x2="18" y2="18"/></svg>
    </button>
    <div class="deck-header">
      <h2 id="deck-title">Today's Cards</h2>
      <div class="deck-counter"><span id="current-num">1</span> of <span id="total-num">12</span></div>
    </div>

    <div class="deck-stage-wrapper">
      <button class="nav-arrow nav-arrow-side nav-arrow-prev" id="nav-prev" aria-label="Previous card">&larr;</button>
      <div class="deck-stage" id="deck-stage"></div>
      <button class="nav-arrow nav-arrow-side nav-arrow-next" id="nav-next" aria-label="Next card">&rarr;</button>
    </div>
    <div class="deck-empty" id="deck-empty">
      <div class="deck-empty-icon">&#9775;</div>
      <div class="deck-empty-text">No cards match that combination.</div>
      <div class="deck-empty-hint">Try a different mood, or reset to see all cards.</div>
    </div>

    <div class="deck-nav" id="deck-nav">
      <div class="nav-dots" id="nav-dots"></div>
    </div>

    <div class="deck-hint" id="deck-hint">
      <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate &nbsp;&middot;&nbsp; <kbd>Space</kbd> to draw next
    </div>

    <p class="about-note">
      The Stoic Way is a living library. Over time this will grow into a
      searchable collection and a place for longer essays on living a flourishing life.
    </p>
  </section>

  <script>
    // ════════════════════════════════════
    //  LOAD QUOTE DATA FROM JSON
    // ════════════════════════════════════
    let allQuotes = [];

    fetch("quotes.json")
      .then(res => {
        if (!res.ok) throw new Error("Could not load quotes.json");
        return res.json();
      })
      .then(data => {
        allQuotes = data;
        initApp();
      })
      .catch(err => {
        console.error(err);
        document.body.innerHTML = '<p style="color:#f55;text-align:center;margin-top:40vh;">Could not load quotes.json &mdash; make sure it\u2019s in the same folder as this file.</p>';
      });

    function initApp() {

    // ════════════════════════════════════
    //  MOOD & THEME DEFINITIONS
    // ════════════════════════════════════
    const moodLabels = {
      "anxious": "Anxious",
      "angry": "Angry",
      "grieving": "Grieving",
      "stuck": "Stuck",
      "overwhelmed": "Overwhelmed",
      "lonely": "Lonely",
      "doubting yourself": "Doubting myself",
      "procrastinating": "Procrastinating",
      "facing change": "Facing change",
    };

    // Extract unique themes from quotes
    const allThemes = [...new Set(allQuotes.map(q => q.theme))];

    // ════════════════════════════════════
    //  FILTER STATE
    // ════════════════════════════════════
    let activeMood = null;
    let activeTheme = null;
    let filteredQuotes = [...allQuotes];

    // ════════════════════════════════════
    //  BUILD FILTER PILLS
    // ════════════════════════════════════
    const moodFiltersEl = document.getElementById("mood-filters");
    const themeFiltersEl = document.getElementById("theme-filters");
    const themeWrap = document.getElementById("theme-filters-wrap");
    const filterReset = document.getElementById("filter-reset");
    const filterCount = document.getElementById("filter-count");
    const deckTitle = document.getElementById("deck-title");

    // Mood pills
    Object.entries(moodLabels).forEach(([key, label]) => {
      const pill = document.createElement("button");
      pill.className = "filter-pill";
      pill.textContent = label;
      pill.dataset.mood = key;
      pill.addEventListener("click", () => toggleMood(key));
      moodFiltersEl.appendChild(pill);
    });

    // Theme pills
    function buildThemePills(availableThemes) {
      themeFiltersEl.innerHTML = "";
      availableThemes.forEach(theme => {
        const pill = document.createElement("button");
        pill.className = "filter-pill theme-pill";
        pill.textContent = theme;
        pill.dataset.theme = theme;
        if (activeTheme === theme) pill.classList.add("active");
        pill.addEventListener("click", () => toggleTheme(theme));
        themeFiltersEl.appendChild(pill);
      });
    }

    buildThemePills(allThemes);

    // ════════════════════════════════════
    //  FILTER LOGIC
    // ════════════════════════════════════
    function toggleMood(mood) {
      if (activeMood === mood) {
        activeMood = null;
      } else {
        activeMood = mood;
      }
      activeTheme = null; // reset theme when mood changes
      applyFilters();
    }

    function toggleTheme(theme) {
      if (activeTheme === theme) {
        activeTheme = null;
      } else {
        activeTheme = theme;
      }
      applyFilters();
    }

    const exploreBtn = document.getElementById("explore-btn");
    const exploreContext = document.getElementById("explore-context");

    function applyFilters() {
      // Compute what WOULD be filtered (for preview count)
      filteredQuotes = allQuotes.filter(q => {
        if (activeMood && !q.moods.includes(activeMood)) return false;
        if (activeTheme && q.theme !== activeTheme) return false;
        return true;
      });

      // Update mood pill states
      moodFiltersEl.querySelectorAll(".filter-pill").forEach(pill => {
        pill.classList.toggle("active", pill.dataset.mood === activeMood);
      });

      // Show/hide theme pills
      if (activeMood) {
        const moodFiltered = allQuotes.filter(q => q.moods.includes(activeMood));
        const availableThemes = [...new Set(moodFiltered.map(q => q.theme))];
        buildThemePills(availableThemes);
        themeWrap.classList.add("visible");
      } else {
        themeWrap.classList.remove("visible");
      }

      // Show/hide reset
      filterReset.classList.toggle("visible", activeMood !== null || activeTheme !== null);

      // Update result count
      if (activeMood) {
        filterCount.textContent = `${filteredQuotes.length} card${filteredQuotes.length !== 1 ? "s" : ""} found`;
      } else {
        filterCount.textContent = "";
      }

      // Update explore context text
      if (activeMood && activeTheme) {
        const moodLabel = moodLabels[activeMood].toLowerCase();
        exploreContext.textContent = `${filteredQuotes.length} card${filteredQuotes.length !== 1 ? "s" : ""} on ${activeTheme.toLowerCase()} for when you're ${moodLabel}`;
      } else if (activeMood) {
        const moodLabel = moodLabels[activeMood].toLowerCase();
        exploreContext.textContent = `${filteredQuotes.length} card${filteredQuotes.length !== 1 ? "s" : ""} for when you're ${moodLabel}`;
      } else {
        exploreContext.textContent = `Browse all ${allQuotes.length} cards in the library`;
      }
    }

    // EXPLORE: commits the filter and scrolls to deck
    function explore() {
      // Apply current filter state to deck
      filteredQuotes = allQuotes.filter(q => {
        if (activeMood && !q.moods.includes(activeMood)) return false;
        if (activeTheme && q.theme !== activeTheme) return false;
        return true;
      });

      // Update deck title
      if (activeMood) {
        const moodLabel = moodLabels[activeMood].toLowerCase();
        deckTitle.textContent = `Cards for when you're ${moodLabel}`;
      } else {
        deckTitle.textContent = "Today's Cards";
      }

      // Rebuild deck and scroll
      currentIndex = 0;
      buildDeck(filteredQuotes);

      setTimeout(() => {
        document.getElementById("deck").scrollIntoView({ behavior: "smooth" });
      }, 80);
    }

    exploreBtn.addEventListener("click", explore);

    filterReset.addEventListener("click", () => {
      activeMood = null;
      activeTheme = null;
      applyFilters();
    });

    // Back-to-filter button
    document.getElementById("back-to-filter").addEventListener("click", () => {
      document.getElementById("filter").scrollIntoView({ behavior: "smooth" });
    });

    // ════════════════════════════════════
    //  DECK STATE & DOM
    // ════════════════════════════════════
    let currentIndex = 0;
    let isAnimating = false;
    let activeQuotes = [...allQuotes]; // the current working set

    const stage      = document.getElementById("deck-stage");
    const dotsWrap   = document.getElementById("nav-dots");
    const currentNum = document.getElementById("current-num");
    const totalNum   = document.getElementById("total-num");
    const prevBtn    = document.getElementById("nav-prev");
    const nextBtn    = document.getElementById("nav-next");
    const deckEmpty  = document.getElementById("deck-empty");
    const deckNav    = document.getElementById("deck-nav");
    const deckHint   = document.getElementById("deck-hint");

    // ════════════════════════════════════
    //  BUILD CARDS
    // ════════════════════════════════════
    let cardEls = [];
    let flipEls = [];

    function buildDeck(quotes) {
      if (!quotes) quotes = allQuotes;
      activeQuotes = quotes;

      stage.innerHTML = "";
      cardEls = [];
      flipEls = [];

      // Handle empty state
      if (quotes.length === 0) {
        deckEmpty.classList.add("visible");
        deckNav.style.display = "none";
        deckHint.style.display = "none";
        totalNum.textContent = "0";
        currentNum.textContent = "0";
        return;
      }

      deckEmpty.classList.remove("visible");
      deckNav.style.display = "flex";
      deckHint.style.display = "block";
      totalNum.textContent = quotes.length;

      quotes.forEach((q, i) => {
        const outer = document.createElement("div");
        outer.className = "deck-card";
        outer.setAttribute("data-index", i);

        const flipper = document.createElement("div");
        flipper.className = "card-flipper";
        if (i !== 0) flipper.classList.add("face-down");

        const front = document.createElement("div");
        front.className = "card-face card-front";
        front.innerHTML = `
          <div class="card-theme-pill">${q.theme}</div>
          <div class="card-quote">${q.quote}</div>
          <div class="card-attribution">
            <span class="card-author">${q.author}</span>
            <span class="card-source">${q.source}</span>
          </div>
          <div class="card-divider"></div>
          <button class="card-explain-toggle" data-idx="${i}">
            What does this mean? <span class="toggle-icon">\u25BC</span>
          </button>
          <div class="card-explanation" id="explain-${i}">
            <div class="card-explanation-inner">${q.explanation}</div>
          </div>
        `;

        const back = document.createElement("div");
        back.className = "card-face card-back";
        back.innerHTML = `
          <div class="card-back-logo">S W</div>
          <div class="card-back-rule"></div>
          <div class="card-back-sub">Stoic Wisdom</div>
        `;

        flipper.appendChild(front);
        flipper.appendChild(back);
        outer.appendChild(flipper);
        stage.appendChild(outer);

        cardEls.push(outer);
        flipEls.push(flipper);
      });

      // Dots
      dotsWrap.innerHTML = "";
      quotes.forEach((_, i) => {
        const dot = document.createElement("div");
        dot.className = "nav-dot";
        dot.addEventListener("click", () => goTo(i));
        dotsWrap.appendChild(dot);
      });

      positionStack();
      attachExplainListeners();
    }

    // ════════════════════════════════════
    //  POSITION THE STACK
    // ════════════════════════════════════
    function positionStack() {
      cardEls.forEach((el, i) => {
        el.classList.remove("swipe-left");
        const offset = i - currentIndex;
        if (offset === 0)      el.setAttribute("data-pos", "0");
        else if (offset === 1) el.setAttribute("data-pos", "1");
        else if (offset === 2) el.setAttribute("data-pos", "2");
        else                   el.setAttribute("data-pos", "hidden");
      });

      document.querySelectorAll(".card-explanation.open").forEach(el => el.classList.remove("open"));
      document.querySelectorAll(".card-explain-toggle.open").forEach(el => el.classList.remove("open"));

      currentNum.textContent = currentIndex + 1;
      dotsWrap.querySelectorAll(".nav-dot").forEach((d, i) =>
        d.classList.toggle("active", i === currentIndex)
      );
    }

    // ════════════════════════════════════
    //  NAVIGATION
    // ════════════════════════════════════
    function goNext() {
      if (isAnimating || currentIndex >= activeQuotes.length - 1) return;
      isAnimating = true;

      const leavingOuter = cardEls[currentIndex];
      const incomingFlip = flipEls[currentIndex + 1];

      leavingOuter.classList.add("swipe-left");

      setTimeout(() => {
        currentIndex++;
        positionStack();
        requestAnimationFrame(() => {
          incomingFlip.classList.remove("face-down");
        });
        setTimeout(() => { isAnimating = false; }, 380);
      }, 250);
    }

    function goPrev() {
      if (isAnimating || currentIndex <= 0) return;
      isAnimating = true;

      const currentFlip = flipEls[currentIndex];
      const returningOuter = cardEls[currentIndex - 1];

      currentFlip.classList.add("face-down");

      setTimeout(() => {
        currentIndex--;
        returningOuter.classList.remove("swipe-left");
        positionStack();
        setTimeout(() => { isAnimating = false; }, 320);
      }, 220);
    }

    function goTo(idx) {
      if (isAnimating || idx === currentIndex) return;
      if (idx < 0 || idx >= activeQuotes.length) return;

      if (idx > currentIndex) {
        isAnimating = true;
        for (let i = currentIndex; i < idx; i++) {
          cardEls[i].classList.add("swipe-left");
        }
        setTimeout(() => {
          currentIndex = idx;
          positionStack();
          requestAnimationFrame(() => {
            flipEls[idx].classList.remove("face-down");
          });
          setTimeout(() => { isAnimating = false; }, 380);
        }, 280);
      } else {
        isAnimating = true;
        for (let i = currentIndex; i > idx; i--) {
          flipEls[i].classList.add("face-down");
        }
        for (let i = currentIndex - 1; i >= idx; i--) {
          cardEls[i].classList.remove("swipe-left");
        }
        setTimeout(() => {
          currentIndex = idx;
          positionStack();
          setTimeout(() => { isAnimating = false; }, 320);
        }, 150);
      }
    }

    // ════════════════════════════════════
    //  EXPLANATION TOGGLE
    // ════════════════════════════════════
    function attachExplainListeners() {
      document.querySelectorAll(".card-explain-toggle").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const panel = document.getElementById(`explain-${btn.dataset.idx}`);
          const isOpen = panel.classList.contains("open");
          panel.classList.toggle("open", !isOpen);
          btn.classList.toggle("open", !isOpen);
          btn.firstChild.textContent = isOpen ? "What does this mean? " : "Close explanation ";
        });
      });
    }

    // ════════════════════════════════════
    //  TOUCH SWIPE
    // ════════════════════════════════════
    let touchStartX = 0, touchStartY = 0, isSwiping = false;

    stage.addEventListener("touchstart", (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isSwiping = false;
    }, { passive: true });

    stage.addEventListener("touchmove", (e) => {
      const dx = e.touches[0].clientX - touchStartX;
      const dy = e.touches[0].clientY - touchStartY;
      if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 15) isSwiping = true;
    }, { passive: true });

    stage.addEventListener("touchend", (e) => {
      if (!isSwiping) return;
      const dx = e.changedTouches[0].clientX - touchStartX;
      if (dx < -50) goNext();
      else if (dx > 50) goPrev();
    });

    // ════════════════════════════════════
    //  KEYBOARD
    // ════════════════════════════════════
    document.addEventListener("keydown", (e) => {
      const tag = e.target.tagName;
      if (tag === "INPUT" || tag === "TEXTAREA" || e.target.isContentEditable) return;
      if (e.code === "ArrowRight" || e.code === "Space") { e.preventDefault(); goNext(); }
      else if (e.code === "ArrowLeft") { e.preventDefault(); goPrev(); }
    });

    // ════════════════════════════════════
    //  BUTTONS & SCROLL
    // ════════════════════════════════════
    nextBtn.addEventListener("click", goNext);
    prevBtn.addEventListener("click", goPrev);
    document.getElementById("reveal-deck").addEventListener("click", () => {
      document.getElementById("filter").scrollIntoView({ behavior: "smooth" });
    });

    document.querySelectorAll("[data-scroll]").forEach(link => {
      link.addEventListener("click", () => {
        const el = document.querySelector(link.getAttribute("data-scroll"));
        if (el) el.scrollIntoView({ behavior: "smooth" });
      });
    });

    const headerEl = document.querySelector("header");
    window.addEventListener("scroll", () => {
      headerEl.classList.toggle("scrolled", window.scrollY > 40);
    });

    // ════════════════════════════════════
    //  INIT
    // ════════════════════════════════════
    buildDeck(allQuotes);

    } // end initApp
  </script>
</body>
</html>

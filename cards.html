<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Stoic Way – Daily Cards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050507;
      --border-subtle: #232323;
      --accent: #f4c15d;
      --accent-soft: #f8dd9b;
      --accent-3: #f06c5f;
      --text: #f5f5f5;
      --muted: #9f9f9f;
      --card-radius: 24px;
      --transition-fast: 0.22s ease-out;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow-x: hidden; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050507;
      color: var(--text);
      min-height: 100vh;
    }

    a { color: inherit; text-decoration: none; }

    /* ───── HEADER ───── */

    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1180px;
      margin: 0 auto;
      padding: 20px 24px;
      transition: padding 0.3s ease, background 0.3s ease;
    }

    header.scrolled {
      padding: 12px 24px;
      background: rgba(5,5,7,0.88);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,0.04);
      left: 0; right: 0;
      max-width: none;
    }

    .logo {
      font-family: "Times New Roman", Georgia, serif;
      font-size: 26px;
      letter-spacing: 0.38em;
      text-transform: uppercase;
    }

    nav { display: flex; gap: 20px; font-size: 13px; text-transform: uppercase; letter-spacing: 0.14em; }
    nav a { color: var(--muted); padding-bottom: 3px; border-bottom: 1px solid transparent; transition: color var(--transition-fast), border-color var(--transition-fast); }
    nav a:hover { color: var(--accent-soft); border-bottom-color: var(--accent-soft); }

    /* ───── FILTER SECTION (primary landing) ───── */

    .filter-section {
      position: relative;
      width: 100%;
      min-height: 100vh;
      padding: 0 24px 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(ellipse at 50% 30%, #0f0f13 0%, #050507 65%);
    }

    .filter-heading {
      font-size: clamp(28px, 4.5vw, 44px);
      font-weight: 700;
      text-align: center;
      margin-bottom: 10px;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeUp 0.7s cubic-bezier(0.22, 1, 0.36, 1) 0.15s forwards;
    }

    .filter-sub {
      font-size: 15px;
      color: var(--muted);
      text-align: center;
      margin-bottom: 40px;
      opacity: 0;
      transform: translateY(16px);
      animation: fadeUp 0.7s cubic-bezier(0.22, 1, 0.36, 1) 0.3s forwards;
    }

    @keyframes fadeUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* ───── PATH CHOOSER ───── */

    .path-chooser {
      display: flex;
      gap: 20px;
      margin-bottom: 28px;
      transition: opacity 0.35s ease, max-height 0.45s cubic-bezier(0.22,1,0.36,1), margin 0.35s ease;
      max-height: 240px;
      overflow: visible;
      opacity: 0;
      transform: translateY(16px);
      animation: fadeUp 0.7s cubic-bezier(0.22, 1, 0.36, 1) 0.5s forwards;
    }

    .path-chooser.hidden {
      opacity: 0 !important;
      max-height: 0;
      margin-bottom: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .path-card {
      flex: 1;
      max-width: 280px;
      padding: 32px 28px 28px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.1);
      background: linear-gradient(160deg, rgba(25,25,30,0.8) 0%, rgba(14,14,18,0.9) 100%);
      cursor: pointer;
      text-align: center;
      transition: all 0.28s cubic-bezier(0.22, 1, 0.36, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .path-card::after {
      content: "\2192";
      display: block;
      margin-top: 6px;
      font-size: 18px;
      color: var(--accent);
      opacity: 0;
      transform: translateX(-6px);
      transition: opacity 0.25s ease, transform 0.25s ease;
    }

    .path-card:hover {
      border-color: var(--accent);
      background: linear-gradient(160deg, rgba(30,30,36,0.9) 0%, rgba(18,18,22,1) 100%);
      transform: translateY(-4px);
      box-shadow: 0 16px 40px rgba(0,0,0,0.55), 0 0 30px rgba(244,193,93,0.06);
    }

    .path-card:hover::after {
      opacity: 1;
      transform: translateX(0);
    }

    .path-card:active {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
    }

    .path-card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 0.02em;
    }

    .path-card-hint {
      font-size: 12px;
      color: #666;
      line-height: 1.6;
    }

    /* ───── FILTER STEPS ───── */

    .filter-step {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
      transition: max-height 0.45s cubic-bezier(0.22,1,0.36,1), opacity 0.35s ease;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .filter-step.visible {
      max-height: 400px;
      opacity: 1;
      pointer-events: auto;
    }

    .filter-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #555;
      margin-bottom: 14px;
      text-align: center;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      max-width: 720px;
      margin-bottom: 24px;
    }

    .filter-pill {
      padding: 9px 20px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(17,17,17,0.5);
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: all var(--transition-fast);
      user-select: none;
    }

    .filter-pill:hover {
      border-color: #3a3a3a;
      color: var(--text);
      background: rgba(30,30,30,0.6);
      transform: translateY(-1px);
    }

    .filter-pill.active {
      border-color: var(--accent);
      color: var(--accent-soft);
      background: rgba(244,193,93,0.08);
      box-shadow: 0 0 16px rgba(244,193,93,0.08);
    }

    .narrow-filters {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height 0.4s cubic-bezier(0.22,1,0.36,1), opacity 0.3s ease, margin 0.3s ease;
      margin-bottom: 0;
    }

    .narrow-filters.visible {
      max-height: 160px;
      opacity: 1;
      margin-bottom: 20px;
    }

    .narrow-filters .filter-row {
      margin-bottom: 0;
    }

    .narrow-pill {
      padding: 6px 14px;
      font-size: 11px;
      letter-spacing: 0.06em;
    }

    .filter-reset {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(240,108,95,0.25);
      border-radius: 999px;
      background: rgba(240,108,95,0.08);
      color: var(--accent-3);
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.06em;
      cursor: pointer;
      padding: 7px 16px 7px 13px;
      margin-bottom: 20px;
      transition: background 0.25s ease, border-color 0.25s ease, transform 0.2s ease;
    }

    .filter-reset svg {
      flex-shrink: 0;
    }

    .filter-reset:hover {
      background: rgba(240,108,95,0.15);
      border-color: rgba(240,108,95,0.4);
    }

    .filter-reset:active {
      transform: scale(0.95);
    }

    .filter-result-count {
      display: none;
    }

    /* ───── EXPLORE BUTTON ───── */

    .explore-wrap {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeUp 0.7s cubic-bezier(0.22, 1, 0.36, 1) 0.65s forwards;
    }

    .explore-divider {
      display: none;
    }

    .explore-button {
      border: none;
      border-radius: 999px;
      padding: 16px 40px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      background: linear-gradient(135deg, var(--accent), var(--accent-3));
      color: #050507;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
    }

    .explore-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 40px rgba(0,0,0,0.7);
      filter: brightness(1.06);
    }

    .explore-button:active {
      transform: translateY(0);
    }

    .explore-context {
      font-size: 13px;
      color: #777;
      max-width: 360px;
      text-align: center;
      line-height: 1.5;
      transition: color 0.3s ease;
    }

    /* ───── BACK TO FILTER (hamburger) ───── */

    .back-to-filter {
      position: absolute;
      top: 24px;
      left: 24px;
      width: 42px;
      height: 42px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: rgba(17,17,17,0.6);
      color: var(--muted);
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: background var(--transition-fast), border-color var(--transition-fast),
                  color var(--transition-fast), transform var(--transition-fast);
    }

    .back-to-filter:hover {
      background: rgba(30,30,30,0.8);
      border-color: #3a3a3a;
      color: var(--accent-soft);
      transform: scale(1.06);
    }

    .back-to-filter:active {
      transform: scale(0.96);
    }

    .back-to-filter svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      fill: none;
    }

    /* ───── DECK SECTION ───── */

    .deck-section {
      position: relative; width: 100%; min-height: 100vh;
      padding: 80px 24px 120px;
      background: radial-gradient(ellipse at top, #0f0f11 0%, #050507 60%);
      display: flex; flex-direction: column; align-items: center;
    }

    .deck-header { text-align: center; margin-bottom: 48px; }
    .deck-header h2 { font-size: 13px; text-transform: uppercase; letter-spacing: 0.2em; color: var(--muted); margin-bottom: 6px; transition: opacity 0.3s ease; }
    .deck-counter { font-size: 12px; color: #555; font-variant-numeric: tabular-nums; }

    /* ═══════════════════════════════════════════
       CARD DECK — 3-layer structure:
       .deck-card    → stack position (translateY, scale, opacity)
       .card-flipper → 3D flip rotation (rotateY)
       .card-front / .card-back → the two faces
       ═══════════════════════════════════════════ */

    .deck-stage {
      position: relative;
      flex: 1 1 auto;
      min-width: 0;
      max-width: 620px;
      min-height: 420px;
      perspective: 1200px;
      transition: height 0.35s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .deck-card {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      cursor: default;
      transition: transform 0.32s cubic-bezier(0.22, 1, 0.36, 1),
                  opacity 0.32s cubic-bezier(0.22, 1, 0.36, 1);
      will-change: transform, opacity;
    }

    .deck-card[data-pos="0"] { z-index: 10; transform: translateY(0) scale(1); opacity: 1; }
    .deck-card[data-pos="1"] { z-index: 9; transform: translateY(16px) scale(0.97); opacity: 0.55; pointer-events: none; }
    .deck-card[data-pos="2"] { z-index: 8; transform: translateY(30px) scale(0.94); opacity: 0.3; pointer-events: none; }
    .deck-card[data-pos="hidden"] { z-index: 1; transform: translateY(44px) scale(0.91); opacity: 0; pointer-events: none; }

    .deck-card.swipe-left {
      transition: transform 0.28s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.25s ease;
      transform: translateX(-130%) rotate(-6deg) !important;
      opacity: 1 !important;
      z-index: 11 !important;
    }

    .card-flipper {
      position: relative;
      width: 100%;
      transform-style: preserve-3d;
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .card-flipper.face-down {
      transform: rotateY(180deg);
    }

    .card-face {
      border-radius: var(--card-radius);
      border: 1px solid var(--border-subtle);
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .card-front {
      position: relative;
      background: radial-gradient(ellipse at top left, #1a1a1c 0%, #0e0e10 55%);
      padding: 36px 32px 28px;
      overflow: hidden;
    }

    .card-back {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: radial-gradient(ellipse at center, #141416 0%, #0b0b0d 70%);
      transform: rotateY(180deg);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
    }

    .card-back::after {
      content: "";
      position: absolute;
      inset: 18px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.05);
      pointer-events: none;
      background: radial-gradient(circle at 50% 40%, rgba(244,193,93,0.025) 0%, transparent 70%);
    }

    .card-back-logo {
      font-family: "Times New Roman", Georgia, serif;
      font-size: 32px;
      letter-spacing: 0.55em;
      color: rgba(255,255,255,0.1);
      text-transform: uppercase;
      padding-left: 0.55em;
    }

    .card-back-rule {
      width: 60px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(244,193,93,0.15), transparent);
    }

    .card-back-sub {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.25em;
      color: rgba(255,255,255,0.05);
    }

    /* ───── CARD CONTENT ───── */

    .card-theme-pill {
      display: inline-block;
      padding: 5px 14px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.4);
      font-size: 11px; text-transform: uppercase; letter-spacing: 0.16em;
      color: var(--accent-soft);
      margin-bottom: 28px;
    }

    .card-quote {
      font-family: Georgia, "Times New Roman", serif;
      font-size: clamp(19px, 2.6vw, 24px);
      line-height: 1.65; font-weight: 400;
      margin-bottom: 24px; color: #f0f0f0;
    }
    .card-quote::before { content: "\201C"; }
    .card-quote::after  { content: "\201D"; }

    .card-attribution { display: flex; align-items: baseline; gap: 10px; margin-bottom: 8px; }
    .card-author { font-size: 18px; font-weight: 600; color: var(--text); }
    .card-source { font-size: 13px; color: var(--muted); font-style: italic; }

    .card-divider {
      width: 40px; height: 1px;
      background: linear-gradient(90deg, var(--accent), transparent);
      margin: 22px 0;
    }

    /* ───── EXPANDABLE EXPLANATION ───── */

    .card-explain-toggle {
      display: inline-flex; align-items: center; gap: 8px;
      border: none; background: none;
      color: var(--accent-soft); font-size: 13px; letter-spacing: 0.06em;
      cursor: pointer; padding: 6px 0;
      transition: color var(--transition-fast);
    }
    .card-explain-toggle:hover { color: var(--accent); }
    .card-explain-toggle .toggle-icon { display: inline-block; transition: transform 0.3s ease; font-size: 11px; }
    .card-explain-toggle.open .toggle-icon { transform: rotate(180deg); }

    .card-explanation {
      max-height: 0; overflow: hidden; opacity: 0;
      transition: max-height 0.4s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.3s ease;
    }
    .card-explanation.open { max-height: 260px; opacity: 1; overflow-y: auto; }
    .card-explanation.open::-webkit-scrollbar { width: 5px; }
    .card-explanation.open::-webkit-scrollbar-track { background: transparent; }
    .card-explanation.open::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    .card-explanation.open::-webkit-scrollbar-thumb:hover { background: #555; }

    .card-explanation-inner { padding-top: 16px; padding-right: 8px; font-size: 14px; line-height: 1.75; color: #c8c8c8; }
    .card-explanation-inner strong { color: var(--accent); font-weight: 500; }

    /* ───── SAVE HEART ───── */

    .card-save-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(0,0,0,0.35);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.22s ease, background 0.22s ease;
      z-index: 5;
    }

    .card-save-btn:hover {
      background: rgba(0,0,0,0.55);
      transform: scale(1.12);
    }

    .card-save-btn:active {
      transform: scale(0.92);
    }

    .card-save-btn svg {
      width: 18px;
      height: 18px;
      transition: fill 0.25s ease, stroke 0.25s ease;
    }

    .card-save-btn .heart-outline {
      stroke: #777;
      stroke-width: 2;
      fill: none;
    }

    .card-save-btn.saved .heart-outline {
      stroke: var(--accent-3);
      fill: var(--accent-3);
    }

    .card-save-btn.saved {
      animation: heartPop 0.35s cubic-bezier(0.22, 1, 0.36, 1);
    }

    @keyframes heartPop {
      0%   { transform: scale(1); }
      40%  { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    /* ───── NAVIGATION ───── */

    .deck-stage-wrapper {
      display: flex;
      align-items: center;
      gap: 16px;
      width: 100%;
      max-width: 700px;
    }

    .deck-nav { display: flex; align-items: center; justify-content: center; gap: 20px; margin-top: 40px; }

    .nav-arrow {
      width: 48px; height: 48px; border-radius: 50%;
      border: 1px solid var(--border-subtle);
      background: rgba(17,17,17,0.6);
      color: var(--muted); font-size: 18px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast),
                  color var(--transition-fast), transform var(--transition-fast);
    }
    .nav-arrow:hover { background: rgba(30,30,30,0.8); border-color: #3a3a3a; color: var(--accent-soft); transform: scale(1.06); }
    .nav-arrow:active { transform: scale(0.96); }

    .nav-arrow-side {
      flex-shrink: 0;
      z-index: 12;
    }

    @media (max-width: 700px) {
      .deck-stage-wrapper { gap: 8px; }
      .nav-arrow-side { width: 36px; height: 36px; font-size: 14px; }
    }

    .nav-dots { display: flex; gap: 8px; }
    .nav-dot { width: 8px; height: 8px; border-radius: 50%; background: #2a2a2a; cursor: pointer; transition: background 0.3s ease, transform 0.3s ease; }
    .nav-dot.active { background: var(--accent); transform: scale(1.25); }

    .deck-hint { margin-top: 16px; font-size: 11px; color: #444; }
    .deck-hint kbd { display: inline-block; padding: 2px 7px; border-radius: 4px; border: 1px solid #333; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 10px; color: #666; background: #111; }

    .about-note { margin-top: 48px; text-align: center; font-size: 13px; color: #444; max-width: 520px; }

    /* ───── EMPTY STATE ───── */

    .deck-empty {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      text-align: center;
      gap: 12px;
    }

    .deck-empty.visible {
      display: flex;
    }

    .deck-empty-icon {
      font-size: 40px;
      opacity: 0.3;
    }

    .deck-empty-text {
      font-size: 15px;
      color: var(--muted);
    }

    .deck-empty-hint {
      font-size: 12px;
      color: #555;
    }

    /* ───── RESPONSIVE ───── */

    @media (max-width: 720px) {
      header { padding: 16px; }
      header.scrolled { padding: 10px 16px; }
      .logo { font-size: 20px; letter-spacing: 0.3em; }
      nav { gap: 14px; font-size: 11px; }
      .filter-section { padding: 80px 16px 40px; min-height: auto; }
      .path-chooser { flex-direction: column; align-items: center; }
      .path-card { max-width: 100%; width: 100%; }
      .filter-row { gap: 8px; }
      .filter-pill { padding: 7px 14px; font-size: 12px; }
      .deck-section { padding: 60px 16px 100px; }
      .deck-stage { max-width: 100%; }
      .card-front { padding: 28px 22px 24px; }
      .card-quote { font-size: 18px; }
      .card-author { font-size: 16px; }
      .card-attribution { flex-direction: column; gap: 4px; }
      .nav-arrow { width: 42px; height: 42px; font-size: 16px; }
      .back-to-filter { top: 16px; left: 16px; width: 38px; height: 38px; }
      .explore-button { padding: 14px 32px; font-size: 13px; }
    }

    @media (max-width: 420px) {
      .deck-stage { min-height: 380px; }
      .card-quote { font-size: 17px; line-height: 1.6; }
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">STOIC&nbsp;WAY</div>
    <nav>
      <a href="library.html">Library</a>
      <a href="index.html">Index</a>
      <a href="admin.html">Admin</a>
    </nav>
  </header>

  <!-- FILTER SECTION (primary landing) -->
  <section class="filter-section" id="filter">
    <h2 class="filter-heading">Find the right thought.</h2>
    <p class="filter-sub">Choose how you'd like to explore the library.</p>

    <!-- Step 1: Choose a path -->
    <div class="path-chooser" id="path-chooser">
      <button class="path-card" id="path-mood">
        <span class="path-card-title">Browse by Mood</span>
        <span class="path-card-hint">Anxious, Stuck, Angry, Grieving&hellip;</span>
      </button>
      <button class="path-card" id="path-theme">
        <span class="path-card-title">Browse by Theme</span>
        <span class="path-card-hint">On Virtue, On Action, On Time&hellip;</span>
      </button>
    </div>

    <!-- Step 2: Mood-first path -->
    <div class="filter-step" id="mood-step">
      <button class="filter-reset" id="reset-mood">
        <svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
        Reset
      </button>
      <div class="filter-label">I'm feeling&hellip;</div>
      <div class="filter-row" id="mood-filters"></div>

      <div class="narrow-filters" id="narrow-theme-wrap">
        <div class="filter-label">Narrow by theme</div>
        <div class="filter-row" id="narrow-theme-filters"></div>
      </div>
    </div>

    <!-- Step 2: Theme-first path -->
    <div class="filter-step" id="theme-step">
      <button class="filter-reset" id="reset-theme">
        <svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
        Reset
      </button>
      <div class="filter-label">Pick a theme</div>
      <div class="filter-row" id="theme-filters"></div>

      <div class="narrow-filters" id="narrow-mood-wrap">
        <div class="filter-label">Narrow by mood</div>
        <div class="filter-row" id="narrow-mood-filters"></div>
      </div>
    </div>

    <div class="filter-result-count" id="filter-count"></div>

    <div class="explore-wrap">
      <div class="explore-divider"></div>
      <button class="explore-button" id="explore-btn">Explore</button>
      <div class="explore-context" id="explore-context">Loading library&hellip;</div>
    </div>
  </section>

  <section class="deck-section" id="deck">
    <button class="back-to-filter" id="back-to-filter" aria-label="Back to filters" title="Change filters">
      <svg viewBox="0 0 24 24"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="14" y2="12"/><line x1="4" y1="18" x2="18" y2="18"/></svg>
    </button>
    <div class="deck-header">
      <h2 id="deck-title">Today's Cards</h2>
      <div class="deck-counter"><span id="current-num">1</span> of <span id="total-num">12</span></div>
    </div>

    <div class="deck-stage-wrapper">
      <button class="nav-arrow nav-arrow-side nav-arrow-prev" id="nav-prev" aria-label="Previous card">&larr;</button>
      <div class="deck-stage" id="deck-stage"></div>
      <button class="nav-arrow nav-arrow-side nav-arrow-next" id="nav-next" aria-label="Next card">&rarr;</button>
    </div>
    <div class="deck-empty" id="deck-empty">
      <div class="deck-empty-icon">&#9775;</div>
      <div class="deck-empty-text">No cards match that combination.</div>
      <div class="deck-empty-hint">Try a different mood, or reset to see all cards.</div>
    </div>

    <div class="deck-nav" id="deck-nav">
      <div class="nav-dots" id="nav-dots"></div>
    </div>

    <div class="deck-hint" id="deck-hint">
      <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate &nbsp;&middot;&nbsp; <kbd>Space</kbd> to draw next
    </div>

    <p class="about-note">
      The Stoic Way is a living library. Over time this will grow into a
      searchable collection and a place for longer essays on living a flourishing life.
    </p>
  </section>

  <script>
    // ════════════════════════════════════
    //  EMBEDDED QUOTE DATA (offline support)
    // ════════════════════════════════════
    const EMBEDDED_QUOTES = [
  {
    "id": 1,
    "theme": "On Action",
    "moods": ["stuck", "procrastinating"],
    "quote": "Waste no more time arguing what a good man should be. Be one.",
    "author": "Marcus Aurelius",
    "source": "Meditations, 10.16",
    "explanation": "Marcus reminds us that philosophy is not theoretical. Virtue is practiced through action, not endless discussion."
  },
  {
    "id": 2,
    "theme": "On Perspective",
    "moods": ["anxious", "overwhelmed"],
    "quote": "We suffer more often in imagination than in reality.",
    "author": "Seneca",
    "source": "Letters from a Stoic, Letter 13",
    "explanation": "Much of our stress comes from anticipation rather than events themselves."
  },
  {
    "id": 3,
    "theme": "On Discipline",
    "moods": ["distracted", "unmotivated"],
    "quote": "No man is free who is not master of himself.",
    "author": "Epictetus",
    "source": "Discourses, Book 2",
    "explanation": "True freedom in Stoicism is self-mastery. Discipline creates autonomy."
  },
  {
    "id": 4,
    "theme": "On Adversity",
    "moods": ["frustrated", "setback"],
    "quote": "The impediment to action advances action. What stands in the way becomes the way.",
    "author": "Marcus Aurelius",
    "source": "Meditations, 5.20",
    "explanation": "Obstacles are not interruptions \u2014 they are the path itself."
  },
  {
    "id": 5,
    "theme": "On Time",
    "moods": ["unfocused", "wasting time"],
    "quote": "It is not that we have a short time to live, but that we waste much of it.",
    "author": "Seneca",
    "source": "On the Shortness of Life",
    "explanation": "Life feels short when attention is fragmented. Intentional living stretches time."
  },
  {
    "id": 6,
    "theme": "On Character",
    "moods": ["self-doubt", "uncertain"],
    "quote": "First say to yourself what you would be; and then do what you have to do.",
    "author": "Epictetus",
    "source": "Discourses, Book 3",
    "explanation": "Identity precedes action. Define your character, then act accordingly."
  },
  {
    "id": 7,
    "theme": "On Resilience",
    "moods": ["tired", "burned out"],
    "quote": "Difficulties strengthen the mind, as labor does the body.",
    "author": "Seneca",
    "source": "Letters from a Stoic, Letter 67",
    "explanation": "Struggle is resistance training for the mind."
  },
  {
    "id": 8,
    "theme": "On Control",
    "moods": ["angry", "reactive"],
    "quote": "It is not things themselves that disturb us, but our judgments about them.",
    "author": "Epictetus",
    "source": "Enchiridion, 5",
    "explanation": "Events are neutral. Our interpretation gives them emotional force."
  },
  {
    "id": 9,
    "theme": "On Perspective",
    "moods": ["anxious", "angry", "stuck", "overwhelmed", "doubting yourself", "procrastinating", "facing change"],
    "quote": "\u201CAll is as thinking makes it so.\u201D The retort made to Monimus the Cynic is clear enough: but clear too is the value of his saying, if one takes the kernel of it, as far as it is true.",
    "author": "Marcus Aurelius",
    "source": "Meditations 2.15",
    "explanation": "Here Marcus recalls a saying attributed as being spoken to Monimus the Cynic, once a slave to a Corinthian money-changer: \u201CAll is as thinking makes it so\u201D - sometimes rendered simply as \u201CAll is opinion.\u201D\n\nTaken literally, this is obviously not true. Fire still burns. Pain still hurts. Loss is still loss. But the value of the statement lies in its great kernel of truth: what disturbs us is not the event itself, but the judgment we attach to it.\n\nEvery perception, emotional impulse, and decision begins with a thought, often one that we so quickly mistake it for reality. We feel insulted because we decide we\u2019ve been wronged. We feel afraid because we judge a situation to be threatening. We feel embarrassed by projecting our fears and paranoias onto the unknowable minds of others.\n\nStoicism asks us to slow that process down.\n\nLetting ourselves fall prey to our impulses lets that part of you which is chaos snatch the reins from that part of you that is reason. If we follow reason, and judgements create our experience, then as long as we are rational, living a life in accordance with nature, we are not powerless. \n\nWe can examine our thoughts. We can replace \u201CThis is terrible\u201D with \u201CThis is difficult, but workable.\u201D We can replace \u201CI\u2019ve failed\u201D with \u201CI\u2019ve learned.\u201D We can choose growth over ego. We can be the audience to our own lives, and one we ought to give a good show.\n\nIn this way, not only does your judgement of reality change, but so too can your character. \n\n\u201CI think therefore I am\u201D\n\nYou become what you repeatedly tell you are. Not empty affirmations, chosen judgements that shape conduct over time. It\u2019s with repetition that all skills are learned, with habit all virtues become character."
  }
];

    // ════════════════════════════════════
    //  SAVED QUOTES (localStorage)
    // ════════════════════════════════════
    function getSavedIds() {
      try { return JSON.parse(localStorage.getItem("stoic_saved") || "[]"); }
      catch { return []; }
    }

    function toggleSavedQuote(id) {
      const ids = getSavedIds();
      const idx = ids.indexOf(id);
      if (idx === -1) ids.push(id);
      else ids.splice(idx, 1);
      localStorage.setItem("stoic_saved", JSON.stringify(ids));
      return idx === -1; // returns true if now saved
    }

    // ════════════════════════════════════
    //  LOAD QUOTE DATA
    // ════════════════════════════════════
    let allQuotes = [];

    // Try to fetch from JSON file first (allows live updates via admin),
    // fall back to embedded data for offline / file:// usage
    fetch("quotes.json")
      .then(res => {
        if (!res.ok) throw new Error("Could not load quotes.json");
        return res.json();
      })
      .then(data => {
        allQuotes = data;
        initApp();
      })
      .catch(err => {
        console.warn("quotes.json unavailable, using embedded data:", err.message);
        allQuotes = EMBEDDED_QUOTES;
        initApp();
      });

    function initApp() {

    // ════════════════════════════════════
    //  MOOD & THEME DEFINITIONS
    // ════════════════════════════════════
    const moodLabels = {
      "anxious": "Anxious",
      "angry": "Angry",
      "grieving": "Grieving",
      "stuck": "Stuck",
      "overwhelmed": "Overwhelmed",
      "lonely": "Lonely",
      "doubting yourself": "Doubting myself",
      "procrastinating": "Procrastinating",
      "facing change": "Facing change",
      "scared": "Scared",
    };

    const allThemes = [...new Set(allQuotes.map(q => q.theme))];

    // ════════════════════════════════════
    //  FILTER STATE
    // ════════════════════════════════════
    let activePath = null;   // "mood" or "theme"
    let activeMood = null;
    let activeTheme = null;
    let filteredQuotes = [...allQuotes];

    // ════════════════════════════════════
    //  DOM REFS
    // ════════════════════════════════════
    const pathChooser      = document.getElementById("path-chooser");
    const moodStep         = document.getElementById("mood-step");
    const themeStep        = document.getElementById("theme-step");
    const moodFiltersEl    = document.getElementById("mood-filters");
    const themeFiltersEl   = document.getElementById("theme-filters");
    const narrowThemeWrap  = document.getElementById("narrow-theme-wrap");
    const narrowThemeEl    = document.getElementById("narrow-theme-filters");
    const narrowMoodWrap   = document.getElementById("narrow-mood-wrap");
    const narrowMoodEl     = document.getElementById("narrow-mood-filters");
    const filterCount      = document.getElementById("filter-count");
    const deckTitle        = document.getElementById("deck-title");
    const exploreBtn       = document.getElementById("explore-btn");
    const exploreContext   = document.getElementById("explore-context");

    // ════════════════════════════════════
    //  PATH CHOOSER
    // ════════════════════════════════════
    document.getElementById("path-mood").addEventListener("click", () => {
      activePath = "mood";
      pathChooser.classList.add("hidden");
      moodStep.classList.add("visible");
      themeStep.classList.remove("visible");
    });

    document.getElementById("path-theme").addEventListener("click", () => {
      activePath = "theme";
      pathChooser.classList.add("hidden");
      themeStep.classList.add("visible");
      moodStep.classList.remove("visible");
    });

    // ════════════════════════════════════
    //  BUILD PILLS
    // ════════════════════════════════════

    // Primary mood pills (mood-first path)
    Object.entries(moodLabels).forEach(([key, label]) => {
      const pill = document.createElement("button");
      pill.className = "filter-pill";
      pill.textContent = label;
      pill.dataset.mood = key;
      pill.addEventListener("click", () => selectMood(key));
      moodFiltersEl.appendChild(pill);
    });

    // Primary theme pills (theme-first path)
    allThemes.forEach(theme => {
      const pill = document.createElement("button");
      pill.className = "filter-pill";
      pill.textContent = theme;
      pill.dataset.theme = theme;
      pill.addEventListener("click", () => selectTheme(theme));
      themeFiltersEl.appendChild(pill);
    });

    // Build narrowing theme pills (shown after mood is picked)
    function buildNarrowThemes(availableThemes) {
      narrowThemeEl.innerHTML = "";
      availableThemes.forEach(theme => {
        const pill = document.createElement("button");
        pill.className = "filter-pill narrow-pill";
        pill.textContent = theme;
        pill.dataset.theme = theme;
        if (activeTheme === theme) pill.classList.add("active");
        pill.addEventListener("click", () => { toggleNarrowTheme(theme); });
        narrowThemeEl.appendChild(pill);
      });
    }

    // Build narrowing mood pills (shown after theme is picked)
    function buildNarrowMoods(availableMoods) {
      narrowMoodEl.innerHTML = "";
      availableMoods.forEach(key => {
        const pill = document.createElement("button");
        pill.className = "filter-pill narrow-pill";
        pill.textContent = moodLabels[key] || key;
        pill.dataset.mood = key;
        if (activeMood === key) pill.classList.add("active");
        pill.addEventListener("click", () => { toggleNarrowMood(key); });
        narrowMoodEl.appendChild(pill);
      });
    }

    // ════════════════════════════════════
    //  FILTER LOGIC
    // ════════════════════════════════════

    function selectMood(mood) {
      activeMood = (activeMood === mood) ? null : mood;
      activeTheme = null;
      applyFilters();
    }

    function selectTheme(theme) {
      activeTheme = (activeTheme === theme) ? null : theme;
      activeMood = null;
      applyFilters();
    }

    function toggleNarrowTheme(theme) {
      activeTheme = (activeTheme === theme) ? null : theme;
      applyFilters();
    }

    function toggleNarrowMood(mood) {
      activeMood = (activeMood === mood) ? null : mood;
      applyFilters();
    }

    function applyFilters() {
      filteredQuotes = allQuotes.filter(q => {
        if (activeMood && !q.moods.includes(activeMood)) return false;
        if (activeTheme && q.theme !== activeTheme) return false;
        return true;
      });

      if (activePath === "mood") {
        // Highlight active mood pill
        moodFiltersEl.querySelectorAll(".filter-pill").forEach(pill => {
          pill.classList.toggle("active", pill.dataset.mood === activeMood);
        });

        // Show narrowing themes if a mood is selected
        if (activeMood) {
          const moodFiltered = allQuotes.filter(q => q.moods.includes(activeMood));
          const available = [...new Set(moodFiltered.map(q => q.theme))];
          buildNarrowThemes(available);
          narrowThemeWrap.classList.add("visible");
        } else {
          narrowThemeWrap.classList.remove("visible");
        }
      }

      if (activePath === "theme") {
        // Highlight active theme pill
        themeFiltersEl.querySelectorAll(".filter-pill").forEach(pill => {
          pill.classList.toggle("active", pill.dataset.theme === activeTheme);
        });

        // Show narrowing moods if a theme is selected
        if (activeTheme) {
          const themeFiltered = allQuotes.filter(q => q.theme === activeTheme);
          const available = [...new Set(themeFiltered.flatMap(q => q.moods))];
          buildNarrowMoods(available);
          narrowMoodWrap.classList.add("visible");
        } else {
          narrowMoodWrap.classList.remove("visible");
        }
      }

      // Result count
      const hasFilter = activeMood || activeTheme;
      if (hasFilter) {
        filterCount.textContent = `${filteredQuotes.length} card${filteredQuotes.length !== 1 ? "s" : ""} found`;
      } else {
        filterCount.textContent = "";
      }

      // Explore context
      const n = filteredQuotes.length;
      const cs = `${n} card${n !== 1 ? "s" : ""}`;
      const themeName = activeTheme ? activeTheme.replace(/^On\s+/i, "").toLowerCase() : "";
      if (activeMood && activeTheme) {
        const ml = moodLabels[activeMood].toLowerCase();
        exploreContext.textContent = `${cs} on ${themeName} for when you're ${ml}`;
      } else if (activeMood) {
        const ml = moodLabels[activeMood].toLowerCase();
        exploreContext.textContent = `${cs} for when you're ${ml}`;
      } else if (activeTheme) {
        exploreContext.textContent = `${cs} on ${themeName}`;
      } else {
        exploreContext.textContent = `Browse all ${allQuotes.length} cards in the library`;
      }
    }

    // EXPLORE: commits the filter and scrolls to deck
    function explore() {
      filteredQuotes = allQuotes.filter(q => {
        if (activeMood && !q.moods.includes(activeMood)) return false;
        if (activeTheme && q.theme !== activeTheme) return false;
        return true;
      });

      if (activeMood && activeTheme) {
        const ml = moodLabels[activeMood].toLowerCase();
        deckTitle.textContent = `${activeTheme} \u2014 feeling ${ml}`;
      } else if (activeMood) {
        const ml = moodLabels[activeMood].toLowerCase();
        deckTitle.textContent = `Cards for when you're ${ml}`;
      } else if (activeTheme) {
        deckTitle.textContent = activeTheme;
      } else {
        deckTitle.textContent = "Today\u2019s Cards";
      }

      currentIndex = 0;
      buildDeck(filteredQuotes);

      setTimeout(() => {
        document.getElementById("deck").scrollIntoView({ behavior: "smooth" });
      }, 80);
    }

    exploreBtn.addEventListener("click", explore);

    function resetFilters() {
      activePath = null;
      activeMood = null;
      activeTheme = null;

      // Fade out the current step, then bring back the chooser
      moodStep.classList.remove("visible");
      themeStep.classList.remove("visible");
      narrowThemeWrap.classList.remove("visible");
      narrowMoodWrap.classList.remove("visible");
      filterCount.textContent = "";
      exploreContext.textContent = `Browse all ${allQuotes.length} cards in the library`;

      // Brief pause so collapse is visible before chooser reappears
      setTimeout(() => {
        pathChooser.classList.remove("hidden");
      }, 200);
    }

    document.getElementById("reset-mood").addEventListener("click", resetFilters);
    document.getElementById("reset-theme").addEventListener("click", resetFilters);

    // Back-to-filter button
    document.getElementById("back-to-filter").addEventListener("click", () => {
      document.getElementById("filter").scrollIntoView({ behavior: "smooth" });
    });

    // ════════════════════════════════════
    //  DECK STATE & DOM
    // ════════════════════════════════════
    let currentIndex = 0;
    let isAnimating = false;
    let activeQuotes = [...allQuotes]; // the current working set

    const stage      = document.getElementById("deck-stage");
    const dotsWrap   = document.getElementById("nav-dots");
    const currentNum = document.getElementById("current-num");
    const totalNum   = document.getElementById("total-num");
    const prevBtn    = document.getElementById("nav-prev");
    const nextBtn    = document.getElementById("nav-next");
    const deckEmpty  = document.getElementById("deck-empty");
    const deckNav    = document.getElementById("deck-nav");
    const deckHint   = document.getElementById("deck-hint");

    // ════════════════════════════════════
    //  BUILD CARDS
    // ════════════════════════════════════
    let cardEls = [];
    let flipEls = [];

    function buildDeck(quotes) {
      if (!quotes) quotes = allQuotes;
      activeQuotes = quotes;

      stage.innerHTML = "";
      cardEls = [];
      flipEls = [];

      // Handle empty state
      if (quotes.length === 0) {
        deckEmpty.classList.add("visible");
        deckNav.style.display = "none";
        deckHint.style.display = "none";
        totalNum.textContent = "0";
        currentNum.textContent = "0";
        return;
      }

      deckEmpty.classList.remove("visible");
      deckNav.style.display = "flex";
      deckHint.style.display = "block";
      totalNum.textContent = quotes.length;

      quotes.forEach((q, i) => {
        const outer = document.createElement("div");
        outer.className = "deck-card";
        outer.setAttribute("data-index", i);

        const flipper = document.createElement("div");
        flipper.className = "card-flipper";
        if (i !== 0) flipper.classList.add("face-down");

        const front = document.createElement("div");
        front.className = "card-face card-front";
        const isSaved = getSavedIds().includes(q.id);
        front.innerHTML = `
          <button class="card-save-btn${isSaved ? ' saved' : ''}" data-quote-id="${q.id}" title="${isSaved ? 'Remove from library' : 'Save to library'}">
            <svg viewBox="0 0 24 24"><path class="heart-outline" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
          </button>
          <div class="card-theme-pill">${q.theme}</div>
          <div class="card-quote">${q.quote}</div>
          <div class="card-attribution">
            <span class="card-author">${q.author}</span>
            <span class="card-source">${q.source}</span>
          </div>
          <div class="card-divider"></div>
          <button class="card-explain-toggle" data-idx="${i}">
            What does this mean? <span class="toggle-icon">\u25BC</span>
          </button>
          <div class="card-explanation" id="explain-${i}">
            <div class="card-explanation-inner">${q.explanation}</div>
          </div>
        `;

        const back = document.createElement("div");
        back.className = "card-face card-back";
        back.innerHTML = `
          <div class="card-back-logo">S W</div>
          <div class="card-back-rule"></div>
          <div class="card-back-sub">Stoic Wisdom</div>
        `;

        flipper.appendChild(front);
        flipper.appendChild(back);
        outer.appendChild(flipper);
        stage.appendChild(outer);

        cardEls.push(outer);
        flipEls.push(flipper);
      });

      // Dots
      dotsWrap.innerHTML = "";
      quotes.forEach((_, i) => {
        const dot = document.createElement("div");
        dot.className = "nav-dot";
        dot.addEventListener("click", () => goTo(i));
        dotsWrap.appendChild(dot);
      });

      positionStack();
      attachExplainListeners();
      attachSaveListeners();
    }

    // ════════════════════════════════════
    //  RESIZE STAGE TO FIT ACTIVE CARD
    // ════════════════════════════════════
    function updateStageHeight() {
      const active = cardEls[currentIndex];
      if (!active) return;
      const front = active.querySelector(".card-front");
      if (!front) return;
      const h = front.scrollHeight + 50; // extra room for stacked cards behind
      stage.style.height = Math.max(420, h) + "px";
    }

    // ════════════════════════════════════
    //  POSITION THE STACK
    // ════════════════════════════════════
    function positionStack() {
      cardEls.forEach((el, i) => {
        el.classList.remove("swipe-left");
        const offset = i - currentIndex;
        if (offset === 0)      el.setAttribute("data-pos", "0");
        else if (offset === 1) el.setAttribute("data-pos", "1");
        else if (offset === 2) el.setAttribute("data-pos", "2");
        else                   el.setAttribute("data-pos", "hidden");
      });

      document.querySelectorAll(".card-explanation.open").forEach(el => el.classList.remove("open"));
      document.querySelectorAll(".card-explain-toggle.open").forEach(el => el.classList.remove("open"));

      currentNum.textContent = currentIndex + 1;
      dotsWrap.querySelectorAll(".nav-dot").forEach((d, i) =>
        d.classList.toggle("active", i === currentIndex)
      );

      updateStageHeight();
    }

    // ════════════════════════════════════
    //  NAVIGATION
    // ════════════════════════════════════
    function goNext() {
      if (isAnimating || currentIndex >= activeQuotes.length - 1) return;
      isAnimating = true;

      const leavingOuter = cardEls[currentIndex];
      const incomingFlip = flipEls[currentIndex + 1];

      leavingOuter.classList.add("swipe-left");

      setTimeout(() => {
        currentIndex++;
        positionStack();
        requestAnimationFrame(() => {
          incomingFlip.classList.remove("face-down");
        });
        setTimeout(() => { isAnimating = false; }, 380);
      }, 250);
    }

    function goPrev() {
      if (isAnimating || currentIndex <= 0) return;
      isAnimating = true;

      const currentFlip = flipEls[currentIndex];
      const returningOuter = cardEls[currentIndex - 1];

      currentFlip.classList.add("face-down");

      setTimeout(() => {
        currentIndex--;
        returningOuter.classList.remove("swipe-left");
        positionStack();
        setTimeout(() => { isAnimating = false; }, 320);
      }, 220);
    }

    function goTo(idx) {
      if (isAnimating || idx === currentIndex) return;
      if (idx < 0 || idx >= activeQuotes.length) return;

      if (idx > currentIndex) {
        isAnimating = true;
        for (let i = currentIndex; i < idx; i++) {
          cardEls[i].classList.add("swipe-left");
        }
        setTimeout(() => {
          currentIndex = idx;
          positionStack();
          requestAnimationFrame(() => {
            flipEls[idx].classList.remove("face-down");
          });
          setTimeout(() => { isAnimating = false; }, 380);
        }, 280);
      } else {
        isAnimating = true;
        for (let i = currentIndex; i > idx; i--) {
          flipEls[i].classList.add("face-down");
        }
        for (let i = currentIndex - 1; i >= idx; i--) {
          cardEls[i].classList.remove("swipe-left");
        }
        setTimeout(() => {
          currentIndex = idx;
          positionStack();
          setTimeout(() => { isAnimating = false; }, 320);
        }, 150);
      }
    }

    // ════════════════════════════════════
    //  EXPLANATION TOGGLE
    // ════════════════════════════════════
    function attachExplainListeners() {
      document.querySelectorAll(".card-explain-toggle").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const panel = document.getElementById(`explain-${btn.dataset.idx}`);
          const isOpen = panel.classList.contains("open");
          panel.classList.toggle("open", !isOpen);
          btn.classList.toggle("open", !isOpen);
          btn.firstChild.textContent = isOpen ? "What does this mean? " : "Close explanation ";
          // Wait for the CSS transition to start, then update stage height
          requestAnimationFrame(() => {
            setTimeout(updateStageHeight, 50);
            setTimeout(updateStageHeight, 400); // after transition completes
          });
        });
      });
    }

    // ════════════════════════════════════
    //  SAVE BUTTON LISTENERS
    // ════════════════════════════════════
    function attachSaveListeners() {
      document.querySelectorAll(".card-save-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const id = parseInt(btn.dataset.quoteId, 10);
          const nowSaved = toggleSavedQuote(id);
          btn.classList.toggle("saved", nowSaved);
          btn.title = nowSaved ? "Remove from library" : "Save to library";
          // Re-trigger animation
          if (nowSaved) {
            btn.classList.remove("saved");
            void btn.offsetWidth; // force reflow
            btn.classList.add("saved");
          }
        });
      });
    }

    // ════════════════════════════════════
    //  TOUCH SWIPE
    // ════════════════════════════════════
    let touchStartX = 0, touchStartY = 0, isSwiping = false;

    stage.addEventListener("touchstart", (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isSwiping = false;
    }, { passive: true });

    stage.addEventListener("touchmove", (e) => {
      const dx = e.touches[0].clientX - touchStartX;
      const dy = e.touches[0].clientY - touchStartY;
      if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 15) isSwiping = true;
    }, { passive: true });

    stage.addEventListener("touchend", (e) => {
      if (!isSwiping) return;
      const dx = e.changedTouches[0].clientX - touchStartX;
      if (dx < -50) goNext();
      else if (dx > 50) goPrev();
    });

    // ════════════════════════════════════
    //  KEYBOARD
    // ════════════════════════════════════
    document.addEventListener("keydown", (e) => {
      const tag = e.target.tagName;
      if (tag === "INPUT" || tag === "TEXTAREA" || e.target.isContentEditable) return;
      if (e.code === "ArrowRight" || e.code === "Space") { e.preventDefault(); goNext(); }
      else if (e.code === "ArrowLeft") { e.preventDefault(); goPrev(); }
    });

    // ════════════════════════════════════
    //  BUTTONS & SCROLL
    // ════════════════════════════════════
    nextBtn.addEventListener("click", goNext);
    prevBtn.addEventListener("click", goPrev);
    document.querySelectorAll("[data-scroll]").forEach(link => {
      link.addEventListener("click", () => {
        const el = document.querySelector(link.getAttribute("data-scroll"));
        if (el) el.scrollIntoView({ behavior: "smooth" });
      });
    });

    const headerEl = document.querySelector("header");
    window.addEventListener("scroll", () => {
      headerEl.classList.toggle("scrolled", window.scrollY > 40);
    });

    // ════════════════════════════════════
    //  INIT
    // ════════════════════════════════════
    exploreContext.textContent = `Browse all ${allQuotes.length} cards in the library`;
    buildDeck(allQuotes);

    } // end initApp
  </script>
</body>
</html>
